(function(){/*

 Copyright 2017 The Web Activities Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS-IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
var c;function h(a,b,d,e,f){this.code=a;this.data="ok"==a?b:null;this.origin=d;this.originVerified=e;this.secureChannel=f;this.ok="ok"==a;this.error="failed"==a?Error(String(b)||""):null};function n(a,b,d){this.a=a;this.U=b;this.f=d;this.B=this.w=null;this.V=this.da.bind(this)}c=n.prototype;c.connect=function(a){if(this.B)throw Error("already connected");this.B=a;this.a.addEventListener("message",this.V)};c.disconnect=function(){this.B&&(this.B=null,this.a.removeEventListener("message",this.V))};c.getTarget=function(){var a=p(this);if(!a)throw Error("not connected");return a};function p(a){a.B&&!a.w&&(a.w="function"==typeof a.U?a.U():a.U);return a.w}
c.getTargetOrigin=function(){if(null==this.f)throw Error("not connected");return this.f};c.sendCommand=function(a,b){var d=this.getTarget(),e="connect"==a?null!=this.f?this.f:"*":this.getTargetOrigin();d.postMessage({sentinel:"__ACTIVITIES__",cmd:a,payload:b||null},e)};c.da=function(a){var b=a.data;if(b&&"__ACTIVITIES__"==b.sentinel){var d=a.origin,e=b.cmd,f=b.payload||null;null==this.f&&"start"==e&&(this.f=d);null==this.f&&a.source&&p(this)==a.source&&(this.f=d);d==this.f&&this.B(e,f)}};function q(a){var b=this;this.a=a;this.w=a.parent;this.b=new n(this.a,this.w,null);this.h=null;this.c=!1;this.i=null;this.D=new Promise(function(a){b.i=a});this.g=!1;this.m=this.j=null;this.G=this.Y=0;this.W=this.fa.bind(this)}c=q.prototype;c.connect=function(){this.g=this.c=!1;this.b.connect(this.s.bind(this));this.b.sendCommand("connect");return this.D};c.disconnect=function(){this.g=this.c=!1;this.b.disconnect();this.a.removeEventListener("resize",this.W)};
c.getRequestString=function(){r(this);return null};c.getMode=function(){return"iframe"};c.getTargetOrigin=function(){r(this);return this.b.getTargetOrigin()};c.isTargetOriginVerified=function(){r(this);return!0};c.isSecureChannel=function(){return!0};c.accept=function(){r(this);this.g=!0};c.getArgs=function(){r(this);return this.h};c.ready=function(){t(this);this.b.sendCommand("ready");this.C();this.a.addEventListener("resize",this.W)};c.setSizeContainer=function(a){this.m=a};
c.onResizeComplete=function(a){this.j=a};c.resized=function(){var a=this;setTimeout(function(){return a.C()},50)};c.result=function(a){this.l("ok",a)};c.cancel=function(){this.l("canceled",null)};c.failed=function(a){this.l("failed",String(a))};function r(a){if(!a.c)throw Error("not connected");}function t(a){if(!a.g)throw Error("not accepted");}c.l=function(a,b){t(this);this.b.sendCommand("result",{code:a,data:b})};
c.s=function(a,b){if("start"==a)this.h=b,this.c=!0,this.i(this),this.i=null;else if("close"==a)this.disconnect();else if("resized"==a){var d=b.height;this.j&&this.j(d,this.G,d<this.G)}};c.C=function(){if(this.m){var a=this.m.scrollHeight;a!=this.G&&(this.G=a,this.b.sendCommand("resize",{height:this.G}))}};c.fa=function(){var a=this.a.innerWidth;this.Y!=a&&(this.Y=a,this.resized())};var u;function v(a){u||(u=document.createElement("a"));u.href=a;return u}function w(a){return a.origin||a.protocol+"//"+a.host}function x(a){var b=a.indexOf("#");return-1==b?a:a.substring(0,b)}function y(a){return a?(/^[?#]/.test(a)?a.slice(1):a).split("&").reduce(function(a,d){var b=d.split("=");d=decodeURIComponent(b[0]||"");var f=decodeURIComponent(b[1]||"");d&&(a[d]=f);return a},{}):{}}function z(a){return JSON.stringify({requestId:a.requestId,returnUrl:a.returnUrl,args:a.args})};function A(a){var b=this;if(!a.opener||a.opener==a)throw Error("No window.opener");this.a=a;this.w=a.opener;this.b=new n(this.a,this.w,null);this.h=null;this.c=!1;this.i=null;this.D=new Promise(function(a){b.i=a});this.g=!1;this.m=this.j=null;this.R=new B(this.a)}c=A.prototype;c.connect=function(a){var b=this;this.g=this.c=!1;return this.R.connect(a).then(function(){b.b.connect(b.s.bind(b));b.b.sendCommand("connect");setTimeout(function(){b.i&&(b.i(b.R),b.i=null)},5E3);return b.D})};
c.disconnect=function(){this.g=this.c=!1;this.b.disconnect();try{this.a.close()}catch(a){}};c.getRequestString=function(){r(this);return this.R.getRequestString()};c.getMode=function(){return"popup"};c.getTargetOrigin=function(){r(this);return this.b.getTargetOrigin()};c.isTargetOriginVerified=function(){r(this);return!0};c.isSecureChannel=function(){return!0};c.accept=function(){r(this);this.g=!0};c.getArgs=function(){r(this);return this.h};c.ready=function(){t(this);this.b.sendCommand("ready")};
c.setSizeContainer=function(a){this.m=a};c.onResizeComplete=function(a){this.j=a};c.resized=function(){var a=this;setTimeout(function(){return a.C()},50)};c.result=function(a){this.l("ok",a)};c.cancel=function(){this.l("canceled",null)};c.failed=function(a){this.l("failed",String(a))};c.ca=function(){if(!this.c)throw Error("not connected");};c.ba=function(){if(!this.g)throw Error("not accepted");};c.l=function(a,b){t(this);this.b.sendCommand("result",{code:a,data:b})};
c.s=function(a,b){"start"==a?(this.h=b,this.c=!0,this.i(this)):"close"==a&&this.disconnect()};c.C=function(){if(this.m){var a=this.m.scrollHeight,b=this.a.innerHeight;this.j&&this.j(b,a,b<a)}};function B(a){this.a=a;this.f=this.N=this.H=null;this.J=!1;this.h=null;this.g=this.c=!1;this.m=this.j=null}c=B.prototype;
c.connect=function(a){var b=this;return Promise.resolve().then(function(){b.c=!1;b.g=!1;var d;if("object"==typeof a)d=a;else{var e;if(a&&"string"==typeof a)e=a;else{var f=y(b.a.location.hash).__WA__;f&&(e=decodeURIComponent(f))}e&&(e?(d=JSON.parse(e),d={requestId:d.requestId,returnUrl:d.returnUrl,args:d.args||null}):d=null)}if(!d||!d.requestId||!d.returnUrl)throw Error("Request must have requestId and returnUrl");b.H=d.requestId;b.h=d.args;b.N=d.returnUrl;b.f=w(v(d.returnUrl));b.J=!1;b.c=!0;return b})};
c.disconnect=function(){this.g=this.c=!1};c.getRequestString=function(){r(this);return z({requestId:this.H,returnUrl:this.N,args:this.h})};c.getMode=function(){return"redirect"};c.getTargetOrigin=function(){r(this);return this.f};c.isTargetOriginVerified=function(){r(this);return this.J};c.isSecureChannel=function(){return!1};c.accept=function(){r(this);this.g=!0};c.getArgs=function(){r(this);return this.h};c.ready=function(){t(this)};c.setSizeContainer=function(a){this.m=a};
c.onResizeComplete=function(a){this.j=a};c.resized=function(){var a=this;setTimeout(function(){return a.C()},50)};c.result=function(a){this.l("ok",a)};c.cancel=function(){this.l("canceled",null)};c.failed=function(a){this.l("failed",String(a))};c.ca=function(){if(!this.c)throw Error("not connected");};c.ba=function(){if(!this.g)throw Error("not accepted");};
c.l=function(a,b){t(this);var d=this.H,e;e=this.a;e=e.origin||w(e.location);a={requestId:d,origin:e,code:a,data:b};var f=this.N+(-1==this.N.indexOf("#")?"#":"&")+"__WA_RES__="+encodeURIComponent(JSON.stringify(a));a=f;this.a.location.replace?this.a.location.replace(a):this.a.location.assign(a)};c.C=function(){if(this.m){var a=this.m.scrollHeight,b=this.a.innerHeight;this.j&&this.j(b,a,b<a)}};function C(a){this.version="0.3.0";this.a=a}C.prototype.connectHost=function(a){var b;b=this.a.top!=this.a?new q(this.a):this.a.opener&&!this.a.opener.closed?new A(this.a):new B(this.a);return b.connect(a)};function D(a,b,d){var e=this;this.F=a;this.O=b;this.h=d||null;this.a=this.F.ownerDocument.defaultView;this.f=w(v(b));this.c=!1;this.i=null;this.D=new Promise(function(a){e.i=a});this.K=null;this.ea=new Promise(function(a){e.K=a});this.o=null;this.M=new Promise(function(a){e.o=a});this.L=this.P=null;this.b=new n(this.a,function(){return e.F.contentWindow},this.f)}c=D.prototype;c.getMode=function(){return"iframe"};
c.connect=function(){if(!this.a.document.documentElement.contains(this.F))throw Error("iframe must be in DOM");this.b.connect(this.s.bind(this));this.F.src=this.O;return this.D};c.disconnect=function(){this.c=!1;this.b.disconnect()};c.getTargetOrigin=function(){return this.b.getTargetOrigin()};c.isTargetOriginVerified=function(){return!0};c.isSecureChannel=function(){return!0};c.acceptResult=function(){return this.M};c.whenReady=function(){return this.ea};
c.onResizeRequest=function(a){var b=this;this.P=a;Promise.resolve().then(function(){null!=b.L&&a(b.L)})};c.resized=function(){this.c&&this.b.sendCommand("resized",{height:this.F.offsetHeight})};
c.s=function(a,b){if("connect"==a)this.c=!0,this.b.sendCommand("start",this.h),this.i();else if("result"==a){if(this.o){a=b.code;var d=new h(a,"failed"==a?Error(b.data||""):b.data,this.getTargetOrigin(),this.isTargetOriginVerified(),this.isSecureChannel());this.o(d);this.o=null;this.b.sendCommand("close");this.disconnect()}}else"ready"==a?this.K&&(this.K(),this.K=null):"resize"==a&&(this.L=b.height,this.P&&this.P(this.L))};function E(a,b,d,e,f,g){var l=this,k=e&&("_blank"==e||"_top"==e||"_"!=e[0]);if(!k)throw Error('The only allowed targets are "_blank", "_top" and name targets');this.a=a;this.H=b;this.O=d;this.Z=e;this.h=f||null;this.u=g||null;this.I=this.o=null;this.M=new Promise(function(a,b){l.o=a;l.I=b});this.b=this.A=this.v=null}c=E.prototype;c.getMode=function(){return"_top"==this.Z?"redirect":"popup"};c.open=function(){return G(this)};
c.disconnect=function(){this.A&&(this.a.clearInterval(this.A),this.A=null);this.b&&(this.b.disconnect(),this.b=null);if(this.v){try{this.v.close()}catch(a){}this.v=null}this.I=this.o=null};c.getTargetOrigin=function(){return this.b.getTargetOrigin()};c.isTargetOriginVerified=function(){return!0};c.isSecureChannel=function(){return!0};c.acceptResult=function(){return this.M};
function G(a){var b=H(a),d=a.u&&a.u.returnUrl||x(a.a.location.href),d=z({requestId:a.H,returnUrl:d,args:a.h}),d=a.O+(-1==a.O.indexOf("#")?"#":"&")+"__WA__="+encodeURIComponent(d),e,f=a.Z;try{e=a.a.open(d,f,b)}catch(g){}if(!e&&"_top"!=f){f="_top";try{e=a.a.open(d,f)}catch(g){}}e?(a.v=e,"_top"!=f&&I(a)):J(a,Error("failed to open window"));return a.M.catch(function(){})}
function H(a){var b=a.a.screen,d=Math.floor(Math.min(600,.9*b.width)),e=Math.floor(Math.min(600,.9*b.height));a.u&&(a.u.width&&(d=Math.min(a.u.width,b.width)),a.u.height&&(e=Math.min(a.u.height,b.height)));a={height:e,width:d,left:Math.floor((b.width-d)/2),top:Math.floor((b.height-e)/2),resizable:"yes",scrollbars:"yes"};var b="",f;for(f in a)b&&(b+=","),b+=f+"="+a[f];return b}
function I(a){a.A=a.a.setInterval(function(){if(!a.v||a.v.closed)a.a.clearInterval(a.A),a.A=null,a.a.setTimeout(function(){try{K(a,"canceled",null)}catch(b){J(a,b)}},3E3)},500);a.b=new n(a.a,a.v,null);a.b.connect(a.s.bind(a))}function J(a,b){a.I&&a.I(b);a.disconnect()}function K(a,b,d){a.o&&(a.o(new h(b,d,a.getTargetOrigin(),a.isTargetOriginVerified(),a.isSecureChannel())),a.o=null,a.I=null);a.b&&a.b.sendCommand("close");a.disconnect()}
c.s=function(a,b){"connect"==a?this.b.sendCommand("start",this.h):"result"==a&&(a=b.code,K(this,a,"failed"==a?Error(b.data||""):b.data))};function L(a,b,d,e){this.$=a;this.aa=b;this.f=d;this.J=e}c=L.prototype;c.getMode=function(){return"redirect"};c.getTargetOrigin=function(){return this.f};c.isTargetOriginVerified=function(){return this.J};c.isSecureChannel=function(){return!1};c.acceptResult=function(){return Promise.resolve(new h(this.$,this.aa,this.f,this.J,this.isSecureChannel()))};function M(a){this.version="0.3.0";this.a=a;this.X=a.location.hash;this.S={};this.T={}}M.prototype.openIframe=function(a,b,d){var e=new D(a,b,d);return e.connect().then(function(){return e})};M.prototype.open=function(a,b,d,e,f){var g=this,l=new E(this.a,a,b,d,e,f);l.open().then(function(){N(g,a,l)})};
M.prototype.onResult=function(a,b){var d=this.S[a];d||(d=[],this.S[a]=d);d.push(b);var e=this.T[a];if(!e&&this.X){var e=this.a,f=y(this.X).__WA_RES__;if(f)if((f=JSON.parse(decodeURIComponent(f)))&&f.requestId==a){var g=e.location.hash;if(g){var l=encodeURIComponent("__WA_RES__")+"=",k=-1;do if(k=g.indexOf(l,k),-1!=k){var m=0<k?g.substring(k-1,k):"";""==m||"?"==m||"#"==m||"&"==m?(m=g.indexOf("&",k+1),-1==m&&(m=g.length),g=g.substring(0,k)+g.substring(m+1)):k++}while(-1!=k&&k<g.length)}g=g||"";if(g!=
e.location.hash&&e.history&&e.history.replaceState)try{e.history.replaceState(e.history.state,"",g)}catch(P){}e=new L(f.code,f.data,f.origin,!1)}else e=null;else e=null;e&&(this.T[a]=e)}var F=e;F&&O(F,b)};function O(a,b){Promise.resolve().then(function(){b(a)})}function N(a,b,d){var e=a.S[b];e&&e.forEach(function(a){O(d,a)});a.T[b]=d};(function(a){function b(a){Promise.resolve().then(function(){a(f)})}var d=new M(a),e=new C(a),f={};Object.defineProperty(f,"version",{value:"0.3.0",configurable:!1});Object.defineProperty(f,"ports",{get:function(){return d}});Object.defineProperty(f,"hosts",{get:function(){return e}});var g=a.ACTIVITIES,l={};Object.defineProperty(l,"push",{get:function(){return b},configurable:!1});a.ACTIVITIES=l;g&&g.forEach(b)})(self);})();
//# sourceMappingURL=activities.min.js.map

