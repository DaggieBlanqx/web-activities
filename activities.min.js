(function(){/*

 Copyright 2017 The Web Activities Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS-IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
var c;function h(a,b,d,e,f,g){this.code=a;this.data="ok"==a?b:null;this.mode=d;this.origin=e;this.originVerified=f;this.secureChannel=g;this.ok="ok"==a;this.error="failed"==a?Error(String(b)||""):null};function m(a,b,d){this.a=a;this.V=b;this.c=d;this.v=this.P=this.C=this.A=null;this.W=this.ea.bind(this)}c=m.prototype;c.connect=function(a){if(this.C)throw Error("already connected");this.C=a;this.a.addEventListener("message",this.W)};c.disconnect=function(){if(this.C&&(this.C=null,this.a.removeEventListener("message",this.W),this.v)){for(var a in this.v){var b=this.v[a];if(b.port1)try{b.port1.close()}catch(d){}if(b.port2)try{b.port2.close()}catch(d){}}this.v=null}};
c.isConnected=function(){return null!=this.c};c.getTarget=function(){var a=p(this);if(!a)throw Error("not connected");return a};function p(a){a.C&&!a.A&&(a.A="function"==typeof a.V?a.V():a.V);return a.A}c.getTargetOrigin=function(){if(null==this.c)throw Error("not connected");return this.c};c.sendCommand=function(a,b,d){var e=this.getTarget(),f="connect"==a?null!=this.c?this.c:"*":this.getTargetOrigin();e.postMessage({sentinel:"__ACTIVITIES__",cmd:a,payload:b||null},f,d||void 0)};
c.customMessage=function(a){this.sendCommand("msg",a)};c.onCustomMessage=function(a){this.P=a};c.startChannel=function(a){a=a||"";var b=q(this,a);if(!b.port1){var d=new this.a.MessageChannel;b.port1=d.port1;b.port2=d.port2;b.resolver(b.port1)}b.port2&&(this.sendCommand("cnset",{name:a},[b.port2]),b.port2=null);return b.promise};c.askChannel=function(a){a=a||"";var b=q(this,a);b.port1||this.sendCommand("cnget",{name:a});return b.promise};
function q(a,b){a.v||(a.v={});var d=a.v[b];if(!d){var e,f=new Promise(function(a){e=a}),d={port1:null,port2:null,resolver:e,promise:f};a.v[b]=d}return d}c.ea=function(a){var b=a.data;if(b&&"__ACTIVITIES__"==b.sentinel){var d=a.origin,e=b.cmd,b=b.payload||null;null==this.c&&"start"==e&&(this.c=d);null==this.c&&a.source&&p(this)==a.source&&(this.c=d);d==this.c&&this.s(e,b,a)}};
c.s=function(a,b,d){"msg"==a?null!=this.P&&null!=b&&this.P(b):"cnget"==a?this.startChannel(b.name):"cnset"==a?(a=d.ports[0],b=q(this,b.name),b.port1=a,b.resolver(a)):this.C(a,b)};function r(a){var b=this;this.a=a;this.A=a.parent;this.b=new m(this.a,this.A,null);this.h=null;this.f=!1;this.i=null;this.G=new Promise(function(a){b.i=a});this.g=!1;this.o=this.l=null;this.I=this.Z=0;this.X=this.ga.bind(this)}c=r.prototype;c.connect=function(){this.g=this.f=!1;this.b.connect(this.s.bind(this));this.b.sendCommand("connect");return this.G};c.disconnect=function(){this.g=this.f=!1;this.b.disconnect();this.a.removeEventListener("resize",this.X)};
c.getRequestString=function(){t(this);return null};c.getMode=function(){return"iframe"};c.getTargetOrigin=function(){t(this);return this.b.getTargetOrigin()};c.isTargetOriginVerified=function(){t(this);return!0};c.isSecureChannel=function(){return!0};c.accept=function(){t(this);this.g=!0};c.getArgs=function(){t(this);return this.h};c.ready=function(){u(this);this.b.sendCommand("ready");this.D();this.a.addEventListener("resize",this.X)};c.setSizeContainer=function(a){this.o=a};
c.onResizeComplete=function(a){this.l=a};c.resized=function(){var a=this;setTimeout(function(){return a.D()},50)};c.isMessagingSupported=function(){return!0};c.message=function(a){u(this);this.b.customMessage(a)};c.onMessage=function(a){u(this);this.b.onCustomMessage(a)};c.messageChannel=function(a){u(this);return this.b.startChannel(a)};c.result=function(a){this.m("ok",a)};c.cancel=function(){this.m("canceled",null)};c.failed=function(a){this.m("failed",String(a))};
function t(a){if(!a.f)throw Error("not connected");}function u(a){if(!a.g)throw Error("not accepted");}c.m=function(a,b){"ok"==a?u(this):t(this);this.b.sendCommand("result",{code:a,data:b})};c.s=function(a,b){if("start"==a)this.h=b,this.f=!0,this.i(this),this.i=null;else if("close"==a)this.disconnect();else if("resized"==a){var d=b.height;this.l&&this.l(d,this.I,d<this.I)}};c.D=function(){if(this.o){var a=this.o.scrollHeight;a!=this.I&&(this.I=a,this.b.sendCommand("resize",{height:this.I}))}};
c.ga=function(){var a=this.a.innerWidth;this.Z!=a&&(this.Z=a,this.resized())};var v;function w(a){v||(v=document.createElement("a"));v.href=a;return v}function x(a){return a.origin||a.protocol+"//"+a.host}function y(a){var b=a.indexOf("#");return-1==b?a:a.substring(0,b)}function z(a){return a?(/^[?#]/.test(a)?a.slice(1):a).split("&").reduce(function(a,d){var b=d.split("=");d=decodeURIComponent(b[0]||"");var f=decodeURIComponent(b[1]||"");d&&(a[d]=f);return a},{}):{}}
function A(a){var b={requestId:a.requestId,returnUrl:a.returnUrl,args:a.args};void 0!==a.origin&&(b.origin=a.origin);void 0!==a.originVerified&&(b.originVerified=a.originVerified);return JSON.stringify(b)}function B(a,b,d){if(b.ok)d(b);else{var e;(e=b.error)||("DOMException"in a?a=new DOMException("AbortError","AbortError"):(a=Error("AbortError"),a.name="AbortError",a.code=20),e=a);a=e;a.activityResult=b;d(Promise.reject(a))}};function C(a){var b=this;if(!a.opener||a.opener==a)throw Error("No window.opener");this.a=a;this.A=a.opener;this.b=new m(this.a,this.A,null);this.h=null;this.f=!1;this.i=null;this.G=new Promise(function(a){b.i=a});this.g=!1;this.o=this.l=null;this.S=new D(this.a)}c=C.prototype;c.connect=function(a){var b=this;this.g=this.f=!1;return this.S.connect(a).then(function(){b.b.connect(b.s.bind(b));b.b.sendCommand("connect");setTimeout(function(){b.i&&(b.i(b.S),b.i=null)},5E3);return b.G})};
c.disconnect=function(){this.g=this.f=!1;this.b.disconnect();try{this.a.close()}catch(a){}};c.getRequestString=function(){t(this);return this.S.getRequestString()};c.getMode=function(){return"popup"};c.getTargetOrigin=function(){t(this);return this.b.getTargetOrigin()};c.isTargetOriginVerified=function(){t(this);return!0};c.isSecureChannel=function(){return!0};c.accept=function(){t(this);this.g=!0};c.getArgs=function(){t(this);return this.h};c.ready=function(){u(this);this.b.sendCommand("ready")};
c.setSizeContainer=function(a){this.o=a};c.onResizeComplete=function(a){this.l=a};c.resized=function(){var a=this;setTimeout(function(){return a.D()},50)};c.isMessagingSupported=function(){return!1};c.message=function(){u(this)};c.onMessage=function(){u(this)};c.messageChannel=function(){u(this);throw Error("not supported");};c.result=function(a){this.m("ok",a)};c.cancel=function(){this.m("canceled",null)};c.failed=function(a){this.m("failed",String(a))};
c.da=function(){if(!this.f)throw Error("not connected");};c.ca=function(){if(!this.g)throw Error("not accepted");};c.m=function(a,b){"ok"==a?u(this):t(this);this.b.sendCommand("result",{code:a,data:b})};c.s=function(a,b){"start"==a?(this.h=b,this.f=!0,this.i(this)):"close"==a&&this.disconnect()};c.D=function(){if(this.o){var a=this.o.scrollHeight,b=this.a.innerHeight;this.l&&this.l(b,a,b<a)}};
function D(a){this.a=a;this.c=this.N=this.J=null;this.F=!1;this.h=null;this.g=this.f=!1;this.o=this.l=null}c=D.prototype;
c.connect=function(a){var b=this;return Promise.resolve().then(function(){b.f=!1;b.g=!1;var d;if(a&&"object"==typeof a)d=a;else{var e=!1,f;if(a&&"string"==typeof a)e=!0,f=a;else{var g=z(b.a.location.hash).__WA__;g&&(f=decodeURIComponent(g))}if(f)if(d=e,d=void 0===d?!1:d,f){f=JSON.parse(f);var k={requestId:f.requestId,returnUrl:f.returnUrl,args:f.args||null};d&&(k.origin=f.origin||void 0,k.originVerified=f.originVerified||void 0);d=k}else d=null}if(!d||!d.requestId||!d.returnUrl)throw Error("Request must have requestId and returnUrl");
b.J=d.requestId;b.h=d.args;b.N=d.returnUrl;if(d.origin)b.c=d.origin,b.F=d.originVerified||!1;else{b.c=x(w(d.returnUrl));var l=b.a.document.referrer&&x(w(b.a.document.referrer));b.F=l==b.c}b.f=!0;return b})};c.disconnect=function(){this.g=this.f=!1};c.getRequestString=function(){t(this);return A({requestId:this.J,returnUrl:this.N,args:this.h,origin:this.c,originVerified:this.F})};c.getMode=function(){return"redirect"};c.getTargetOrigin=function(){t(this);return this.c};
c.isTargetOriginVerified=function(){t(this);return this.F};c.isSecureChannel=function(){return!1};c.accept=function(){t(this);this.g=!0};c.getArgs=function(){t(this);return this.h};c.ready=function(){u(this)};c.setSizeContainer=function(a){this.o=a};c.onResizeComplete=function(a){this.l=a};c.resized=function(){var a=this;setTimeout(function(){return a.D()},50)};c.isMessagingSupported=function(){return!1};c.message=function(){u(this)};c.onMessage=function(){u(this)};
c.messageChannel=function(){u(this);throw Error("not supported");};c.result=function(a){this.m("ok",a)};c.cancel=function(){this.m("canceled",null)};c.failed=function(a){this.m("failed",String(a))};c.da=function(){if(!this.f)throw Error("not connected");};c.ca=function(){if(!this.g)throw Error("not accepted");};
c.m=function(a,b){"ok"==a?u(this):t(this);var d=this.J,e;e=this.a;e=e.origin||x(e.location);a={requestId:d,origin:e,code:a,data:b};var f=this.N+(-1==this.N.indexOf("#")?"#":"&")+"__WA_RES__="+encodeURIComponent(JSON.stringify(a));a=f;this.a.location.replace?this.a.location.replace(a):this.a.location.assign(a)};c.D=function(){if(this.o){var a=this.o.scrollHeight,b=this.a.innerHeight;this.l&&this.l(b,a,b<a)}};function E(a){this.version="1.2.1";this.a=a}E.prototype.connectHost=function(a){var b;b=this.a.top!=this.a?new r(this.a):this.a.opener&&!this.a.opener.closed?new C(this.a):new D(this.a);return b.connect(a)};function F(a,b,d){var e=this;this.H=a;this.O=b;this.h=d||null;this.a=this.H.ownerDocument.defaultView;this.c=x(w(b));this.f=!1;this.i=null;this.G=new Promise(function(a){e.i=a});this.K=null;this.fa=new Promise(function(a){e.K=a});this.j=null;this.M=new Promise(function(a){e.j=a});this.L=this.R=null;this.b=new m(this.a,function(){return e.H.contentWindow},this.c)}c=F.prototype;c.getMode=function(){return"iframe"};
c.connect=function(){if(!this.a.document.documentElement.contains(this.H))throw Error("iframe must be in DOM");this.b.connect(this.s.bind(this));this.H.src=this.O;return this.G};c.disconnect=function(){this.f=!1;this.b.disconnect()};c.acceptResult=function(){return this.M};c.message=function(a){this.b.customMessage(a)};c.onMessage=function(a){this.b.onCustomMessage(a)};c.messageChannel=function(a){return this.b.askChannel(a)};c.whenReady=function(){return this.fa};
c.onResizeRequest=function(a){var b=this;this.R=a;Promise.resolve().then(function(){null!=b.L&&a(b.L)})};c.resized=function(){this.f&&this.b.sendCommand("resized",{height:this.H.offsetHeight})};
c.s=function(a,b){"connect"==a?(this.f=!0,this.b.sendCommand("start",this.h),this.i()):"result"==a?this.j&&(a=b.code,b=new h(a,"failed"==a?Error(b.data||""):b.data,"iframe",this.b.getTargetOrigin(),!0,!0),B(this.a,b,this.j),this.j=null,this.b.sendCommand("close"),this.disconnect()):"ready"==a?this.K&&(this.K(),this.K=null):"resize"==a&&(this.L=b.height,this.R&&this.R(this.L))};function G(a,b,d,e,f,g){var k=this,l=e&&("_blank"==e||"_top"==e||"_"!=e[0]);if(!l)throw Error('The only allowed targets are "_blank", "_top" and name targets');this.a=a;this.J=b;this.O=d;this.$=e;this.h=f||null;this.u=g||null;this.j=null;this.M=new Promise(function(a){k.j=a});this.b=this.B=this.w=null}c=G.prototype;c.getMode=function(){return"_top"==this.$?"redirect":"popup"};c.open=function(){return H(this)};
c.disconnect=function(){this.B&&(this.a.clearInterval(this.B),this.B=null);this.b&&(this.b.disconnect(),this.b=null);if(this.w){try{this.w.close()}catch(a){}this.w=null}this.j=null};c.acceptResult=function(){return this.M};
function H(a){var b=I(a),d=a.O;if(!a.u||!a.u.skipRequestInUrl)var e=a.u&&a.u.returnUrl||y(a.a.location.href),e=A({requestId:a.J,returnUrl:e,args:a.h}),d=d+(-1==d.indexOf("#")?"#":"&")+encodeURIComponent("__WA__")+"="+encodeURIComponent(e);var f,g=a.$;try{f=a.a.open(d,g,b)}catch(k){}if(!f&&"_top"!=g){g="_top";try{f=a.a.open(d,g)}catch(k){}}f?(a.w=f,"_top"!=g&&J(a)):L(a,Error("failed to open window"));return a.M.catch(function(){})}
function I(a){var b=a.a.screen,d=Math.floor(Math.min(600,.9*b.width)),e=Math.floor(Math.min(600,.9*b.height));a.u&&(a.u.width&&(d=Math.min(a.u.width,b.width)),a.u.height&&(e=Math.min(a.u.height,b.height)));a={height:e,width:d,left:Math.floor((b.width-d)/2),top:Math.floor((b.height-e)/2),resizable:"yes",scrollbars:"yes"};var b="",f;for(f in a)b&&(b+=","),b+=f+"="+a[f];return b}
function J(a){a.B=a.a.setInterval(function(){if(!a.w||a.w.closed)a.a.clearInterval(a.B),a.B=null,a.a.setTimeout(function(){try{M(a,"canceled",null)}catch(b){L(a,b)}},3E3)},500);a.b=new m(a.a,a.w,null);a.b.connect(a.s.bind(a))}function L(a,b){a.j&&a.j(Promise.reject(b));a.disconnect()}function M(a,b,d){if(a.j){var e=a.b.isConnected();b=new h(b,d,"popup",e?a.b.getTargetOrigin():x(w(a.O)),e,e);B(a.a,b,a.j);a.j=null}a.b&&a.b.sendCommand("close");a.disconnect()}
c.s=function(a,b){"connect"==a?this.b.sendCommand("start",this.h):"result"==a&&(a=b.code,M(this,a,"failed"==a?Error(b.data||""):b.data))};function N(a,b,d,e,f){this.a=a;this.aa=b;this.ba=d;this.c=e;this.F=f}N.prototype.getMode=function(){return"redirect"};N.prototype.acceptResult=function(){var a=this,b=new h(this.aa,this.ba,"redirect",this.c,this.F,!1);return new Promise(function(d){B(a.a,b,d)})};function O(a){this.version="1.2.1";this.a=a;this.Y=a.location.hash;this.T={};this.U={}}O.prototype.openIframe=function(a,b,d){var e=new F(a,b,d);return e.connect().then(function(){return e})};O.prototype.open=function(a,b,d,e,f){var g=this,k=new G(this.a,a,b,d,e,f);k.open().then(function(){P(g,a,k)})};
O.prototype.onResult=function(a,b){var d=this.T[a];d||(d=[],this.T[a]=d);d.push(b);var e=this.U[a];if(!e&&this.Y){var e=this.a,f=z(this.Y).__WA_RES__;if(f)if((f=JSON.parse(decodeURIComponent(f)))&&f.requestId==a){var g=e.location.hash;if(g){var k=encodeURIComponent("__WA_RES__")+"=",l=-1;do if(l=g.indexOf(k,l),-1!=l){var n=0<l?g.substring(l-1,l):"";""==n||"?"==n||"#"==n||"&"==n?(n=g.indexOf("&",l+1),-1==n&&(n=g.length),g=g.substring(0,l)+g.substring(n+1)):l++}while(-1!=l&&l<g.length)}g=g||"";if(g!=
e.location.hash&&e.history&&e.history.replaceState)try{e.history.replaceState(e.history.state,"",g)}catch(R){}g=f.code;k=f.data;f=f.origin;l=e.document.referrer&&x(w(e.document.referrer));e=new N(e,g,k,f,f==l)}else e=null;else e=null;e&&(this.U[a]=e)}var K=e;K&&Q(K,b)};function Q(a,b){Promise.resolve().then(function(){b(a)})}function P(a,b,d){var e=a.T[b];e&&e.forEach(function(a){Q(d,a)});a.U[b]=d};(function(a){function b(a){Promise.resolve().then(function(){a(f)})}var d=new O(a),e=new E(a),f={};Object.defineProperty(f,"version",{value:"1.2.1",configurable:!1});Object.defineProperty(f,"ports",{get:function(){return d}});Object.defineProperty(f,"hosts",{get:function(){return e}});var g=a.ACTIVITIES,k={};Object.defineProperty(k,"push",{get:function(){return b},configurable:!1});a.ACTIVITIES=k;g&&g.forEach(b)})(self);})();
//# sourceMappingURL=activities.min.js.map

